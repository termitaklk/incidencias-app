<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Proyecto 2 ‚Äì Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <!-- antes del cierre de <head> (si a√∫n no lo tienes) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

<style>
  /* ---------- BASE ---------- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;
    font-family:Poppins,sans-serif;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#f1f5f9
  }
  .app{width:100%;max-width:1100px}
  .card{
    backdrop-filter:blur(12px) saturate(180%);background:rgba(255,255,255,.45);
    border:1px solid rgba(255,255,255,.25);border-radius:1rem;
    box-shadow:0 8px 24px rgba(0,0,0,.15);padding:2.5rem;overflow:visible
  }
  h1{text-align:center;margin-bottom:1.5rem;color:#fff;font:600 1.6rem Poppins}
  .group{display:flex;flex-direction:column;gap:.25rem;margin:1rem 0}
  .group label{font:.85rem Poppins;color:#e0e7ff}

  /* ---------- CONTROLES ---------- */
  input,select,textarea,button{font-family:Poppins;transition:.2s}
  input,select,textarea{
    background:rgba(255,255,255,.25);border:1px solid transparent;
    padding:.7rem .9rem;border-radius:.65rem;font:.92rem;color:#fff;width:100%
  }
  input:focus,select:focus,textarea:focus{
    outline:none;border-color:#c7d2fe;background:rgba(255,255,255,.35)
  }
  button{
    background:#6366f1;border:none;padding:.85rem 1rem;border-radius:.75rem;
    color:#fff;cursor:pointer;font:500 1rem
  }
  button:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.2)}
  button:active{transform:scale(.97)}
  .hidden{display:none!important}

  /* ---------- LAYOUT ---------- */
  #menu{display:none;gap:1rem;justify-content:center;margin-bottom:1.5rem}
  #menu button{
    background:rgba(255,255,255,.25);border:none;padding:.75rem 1.25rem;
    border-radius:.65rem;color:#fff
  }
  #menu button.active,#menu button:hover{background:rgba(255,255,255,.4)}

  .sections{display:none}
  .section{display:none}
  .section.active{display:block}

  .tabs{display:flex;gap:1rem;justify-content:center;margin-bottom:1rem}
  .tabs button{
    background:rgba(255,255,255,.25);border:none;padding:.5rem 1rem;
    border-radius:.5rem;color:#fff;cursor:pointer
  }
  .tabs button.active{background:rgba(255,255,255,.4)}
  .tab-content{display:none}
  .tab-content.active{display:block}

  .config-form{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
  .config-form .group{flex:1 1 200px}

  .config-table{
    width:100%;border-collapse:collapse;margin-bottom:1rem;text-align:center
  }
  .config-table th,.config-table td{
    border:1px solid rgba(255,255,255,.3);padding:.5rem
  }

  /* ---------- INCIDENCIAS (REGISTRO) ---------- */
  #incContainer{display:flex;flex-direction:column;gap:.8rem;width:100%}
  .incRow{display:flex;gap:1.25rem;width:100%}
  .cat-col{flex:0 0 200px;max-width:200px}
  .coment-col{flex:1 1 auto;min-width:0;display:flex;flex-direction:column}
  .coment-wrapper{position:relative;display:flex;align-items:center;width:100%}
  .coment{flex:1;width:100%;padding-right:2.1rem}
  .delInc{
    position:absolute;top:50%;right:.65rem;transform:translateY(-50%);
    background:none;border:none;width:1.25rem;height:1.25rem;
    display:flex;align-items:center;justify-content:center;
    font-size:1.05rem;color:#f43f5e;cursor:pointer;border-radius:.35rem;transition:.15s
  }
  .delInc:hover{background:rgba(244,63,94,.18);transform:translateY(-50%) scale(1.15)}
  .delInc:active{transform:translateY(-50%) scale(.9)}
  #incContainer .incRow:not(:first-child) .cat-col > label,
  #incContainer .incRow:not(:first-child) .coment-col > label{
    visibility:hidden;height:0;margin:0;padding:0
  }

  /* ---------- REPORTE: alineaci√≥n ---------- */
  #repIncTable th:nth-child(-n+3),
  #repIncTable td:nth-child(-n+3),
  #repIncTable th:nth-child(-n+5),
  #repIncTable td:nth-child(-n+5){
    text-align:center;
  }

  /* ---------- SELECTS ---------- */

  /* Campo select (mismo fondo que inputs) */
  select{
    background:rgba(255,255,255,.25);
    color:#fff;
    border:1px solid transparent;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
  }
  select:focus{
    background:rgba(255,255,255,.35);
    border-color:#c7d2fe;
  }

  /* --- BASE DEL SELECT (campo visible) -------------------------------- */
  select{
    background:rgba(255,255,255,.25);
    color:#fff;
    border:1px solid transparent;
    -webkit-appearance:none;-moz-appearance:none;appearance:none;
  }
  select:focus{
    background:rgba(255,255,255,.35);
    border-color:#c7d2fe;
  }

  /* --- OPCIONES DEL DESPLEGABLE -------------------------------------- */
  /* 1 ‚ñ∏ opciones normales (NO llevan data-usado)  */
  select option:not([data-usado]){
    background:#c7d2fe;          /* mismo lila claro */
    color:#000;                  /* texto negro      */
  }

  /* 2 ‚ñ∏ opciones bloqueadas (llevan data-usado="1") */
  select option[data-usado]{
    background:#a9a0e0;          /* lila un poco m√°s oscuro */
    color:#f43f5e;               /* texto rojo              */
    cursor:not-allowed;
    font-style:italic;
  }

  /* ---------- REPORTE ---------- */
  #repFiltro{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
    gap:1rem;
    margin-bottom:1rem
  }
  #repFiltro .group{margin:0}
  #repIncTable th,#repIncTable td{
    padding:.45rem .35rem;border:1px solid rgba(255,255,255,.25);font-size:.85rem
  }
  #repIncTable td{text-align:left}
</style>

</head>
<body>
  <div class="app">

    <!-- LOGIN -->
    <form id="loginForm" class="card" style="max-width:400px;margin:auto">
      <h1>Acceso al sistema</h1>
      <div class="group"><label>Usuario</label><input id="user" required></div>
      <div class="group"><label>Clave</label><input id="pass" type="password" required></div>
      <button>Entrar</button>
      <p id="loginError" class="hidden">‚ùå Usuario o clave inv√°lido</p>
    </form>

    <!-- MEN√ö -->
    <div id="menu">
      <button data-sec="incidencias" class="active">Incidencias</button>
      <button data-sec="cuadre">Cuadre de Caja</button>
      <button data-sec="cfg">Configuraci√≥n</button>
      <button id="btnLogout">Salir</button>
    </div>

    <!-- SECCIONES -->
    <div class="sections">

      <!-- INCIDENCIAS -->
      <section id="incidencias" class="section active">
        <div class="card">
          <h1>Incidencias</h1>

          <div class="tabs" id="incidTabs">
            <button data-itab="grupos"  class="active">GRUPOS</button>
            <button data-itab="registro">Registro</button>
            <button data-itab="reporte">Reporte</button>
          </div>

          <!-- TAB GRUPOS -->
          <div id="itab-grupos" class="tab-content active">
            <form id="incidenciaForm" class="config-form" onsubmit="return false">
              <div class="group"><label>Fecha</label><input type="date" id="inc_fecha" required></div>
              <div class="group"><label>Ruta</label>
                <select id="inc_ruta" required><option value="">Seleccione‚Ä¶</option></select>
              </div>
              <div class="group"><label>Grupo</label>
                <select id="inc_grupo" required><option value="">Seleccione‚Ä¶</option></select>
              </div>
              <div class="group"><label>Color</label>
                <select id="inc_color" required><option value="">Seleccione‚Ä¶</option></select>
              </div>
              <div class="group"><label>Gu√≠a</label>
                <select id="inc_guia" required><option value="">Seleccione‚Ä¶</option></select>
              </div>
              <div class="group"><label>Clientes PAX</label><input type="number" min="0" id="inc_pax" required></div>
              <div class="group"><label>Hora de Llegada</label>
                <input type="text" id="inc_llegada" placeholder="Hora:Minuto" required>
              </div>
              <button id="btnRegGrupo">Registrar Grupo</button>
            </form>
          </div>

          <!-- TAB REGISTRO -->
          <div id="itab-registro" class="tab-content">
            <form id="regForm" class="config-form" onsubmit="return false">
              <div class="row-turno-grupo" style="display:flex;gap:1rem;flex:0 0 100%;flex-wrap:wrap">
                <div class="group" style="flex:0 0 200px">
                  <label>Turno:</label>
                  <select id="reg_turno" required></select>
                </div>
                <div class="group" style="flex:1 1 auto;min-width:260px">
                  <label>Grupo:</label>
                  <select id="reg_grupo" required><option value="">Seleccione un grupo</option></select>
                </div>
              </div>

              <div id="incContainer">
                <div class="incRow">
                  <div class="group cat-col">
                    <label>Categor√≠a:</label>
                    <select class="cat" required></select>
                  </div>
                  <div class="group coment-col">
                    <label>Comentario:</label>
                    <div class="coment-wrapper">
                      <input class="coment" placeholder="Comentario" required>
                      <button type="button" class="delInc">‚úñ</button>
                    </div>
                  </div>
                </div>
              </div>

              <div style="flex:0 0 100%;display:flex;gap:1rem;justify-content:center;margin-top:1.5rem">
                <button type="button" id="btnAddInc"  style="background:#7c3aed">‚ûï A√±adir Incidencia</button>
                <button type="button" id="btnSendInc" style="background:#0b5cff">üì¢ Reportar Incidencia</button>
              </div>
            </form>
          </div>

          <!-- TAB REPORTE -->
          <div id="itab-reporte" class="tab-content">
            <form id="repFiltro" onsubmit="return false">
              <div class="group"><label>Desde</label><input type="date" id="rep_desde"></div>
              <div class="group"><label>Hasta</label><input type="date" id="rep_hasta"></div>
              <div class="group"><label>Turno</label><select id="rep_turno"><option value="">Todos</option></select></div>
              <div class="group"><label>Grupo</label><select id="rep_grupo"><option value="">Todos</option></select></div>
              <div class="group"><label>Categor√≠a</label><select id="rep_cat"><option value="">Todas</option></select></div>
              <div class="group" style="align-self:flex-end"><button id="repBuscar">Buscar</button></div>
              <!-- ‚¨áÔ∏è  nuevo -->
              <div class="group" style="align-self:flex-end"><button id="repExport" style="background:#0b5cff">Exportar Excel</button></div>
            </form>

            <table id="repIncTable" class="config-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Categor√≠a</th>          <!-- ‚Üê¬†ahora va de segunda -->
                  <th>Turno</th>
                  <th>Grupo</th>
                  <th>Ruta</th>
                  <th>Gu√≠a</th>
                  <th>Color</th>
                  <th>Comentario</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </div>
      </section>

      <!-- CUADRE -->
      <section id="cuadre" class="section">
        <div class="card"><h1>Cuadre de Caja</h1></div>
      </section>

      <!-- CONFIGURACI√ìN -->
      <section id="cfg" class="section">
        <div class="card">
          <h1>Configuraci√≥n</h1>
          <div class="tabs" id="cfgTabs">
            <button data-tab="users" class="active">Usuarios</button>
            <button data-tab="guias">Gu√≠as</button>
            <button data-tab="colores">Colores</button>
            <button data-tab="grupos">Grupos</button>   <!-- üÜï -->
            <button data-tab="rutas">Rutas</button>     <!-- üÜï -->
            <button data-tab="turnos">Turnos</button>   <!-- üÜï -->
          </div>
          <!-- üÜï ========== GRUPOS ========== -->
          <div id="tab-grupos" class="tab-content">
            <form id="grupoForm" class="config-form">
              <div class="group"><label>Grupo</label><input id="g_desc" required></div>
              <button id="grupoSubmit">Agregar/Guardar</button>
              <button id="grupoCancel" class="hidden">Cancelar</button>
            </form>
            <table class="config-table" id="gruposTable">
              <thead><tr><th>Grupo</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- üÜï ========== RUTAS ========== -->
          <div id="tab-rutas" class="tab-content">
            <form id="rutaForm" class="config-form">
              <div class="group"><label>Ruta</label><input id="r_desc" required></div>
              <button id="rutaSubmit">Agregar/Guardar</button>
              <button id="rutaCancel" class="hidden">Cancelar</button>
            </form>
            <table class="config-table" id="rutasTable">
              <thead><tr><th>Ruta</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- üÜï ========== TURNOS ========== -->
          <div id="tab-turnos" class="tab-content">
            <form id="turnoForm" class="config-form">
              <div class="group"><label>Turno</label><input id="t_desc" required></div>
              <button id="turnoSubmit">Agregar/Guardar</button>
              <button id="turnoCancel" class="hidden">Cancelar</button>
            </form>
            <table class="config-table" id="turnosTable">
              <thead><tr><th>Turno</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB GUIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div id="tab-guias" class="tab-content">
            <form id="guiaForm" class="config-form">
              <div class="group"><label>Gu√≠a</label><input id="g_nombre" required></div>
              <button id="guiaSubmit">Agregar/Guardar</button>
              <button id="guiaCancel" class="hidden">Cancelar</button>
            </form>

            <table class="config-table" id="guiasTable">
              <thead><tr><th>Gu√≠a</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB COLORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
          <div id="tab-colores" class="tab-content">
            <form id="colorForm" class="config-form">
              <div class="group"><label>Color</label><input id="c_nombre" required></div>
              <button id="colorSubmit">Agregar/Guardar</button>
              <button id="colorCancel" class="hidden">Cancelar</button>
            </form>

            <table class="config-table" id="coloresTable">
              <thead><tr><th>Color</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="tab-users" class="tab-content active">
            <form id="userForm" class="config-form">
              <div class="group"><label>Usuario</label><input id="u_user" required></div>
              <div class="group"><label>Clave</label><input id="u_pass" required></div>
              <div class="group"><label>Rol</label>
                <select id="u_rol"><option>Usuario</option><option>Supervisor</option><option>Admin</option></select>
              </div>
              <button id="userSubmit">Agregar/Guardar</button>
              <button id="userCancel" class="hidden">Cancelar</button>
            </form>
            <table class="config-table" id="usersTable">
              <thead><tr><th>Usuario</th><th>Rol</th><th>Activo</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    const $  = q => document.querySelector(q);
    const $$ = q => document.querySelectorAll(q);
    const todayISO = () => new Date().toISOString().split('T')[0];

    let CAT_OPTIONS_HTML = '';

    /* helper gen√©rico ------------------------------------------- */
    async function cargarCatalogo(selectId, endpoint, placeholder='Seleccione‚Ä¶') {
      const sel = document.getElementById(selectId);
      if (!sel) return;

      sel.innerHTML = `<option value="">${placeholder}</option>`;

      try {
        const data = await fetch(endpoint).then(r => r.json());
        // ‚¨áÔ∏è  SOLO los que est√°n activos
        data.filter(it => Number(it.activo)).forEach(item => {
          sel.insertAdjacentHTML(
            'beforeend',
            `<option value="${item.id}">${item.descripcion}</option>`
          );
        });
      } catch (err) {
        console.error(`Error cargando ${endpoint}`, err);
      }
    }

    function refrescarCombos() {
      cargarCatalogo('inc_ruta','/api/rutas');
      cargarCatalogo('inc_grupo','/api/grupos');
      cargarCatalogo('reg_grupo','/api/grupos','Seleccione un grupo');
      cargarTurnos();                 // reg_turno + rep_turno
    }


    async function marcarUsados({selectId, urlTodo, urlDisponibles, placeholder}) {
      const sel = document.getElementById(selectId);
      if (!sel) return;

      /* 1. cat√°logo completo ------------------------------- */
      sel.innerHTML = `<option value="">${placeholder}</option>`;
      const todos = await fetch(urlTodo).then(r => r.json());
      todos.forEach(it => sel.insertAdjacentHTML(
        'beforeend', `<option value="${it.id}">${it.descripcion}</option>`));

      /* 2. SINCRONIZA ‚Äúusados / disponibles‚Äù ---------------- */
      const disponibles = await fetch(urlDisponibles).then(r => r.json());
      const setDisp = new Set(disponibles.map(d => String(d.id)));

      /* 3. primero quita cualquier marca previa ------------- */
      sel.querySelectorAll('option').forEach(opt => {
        if (!opt.value) return;          // placeholder
        opt.disabled = false;
        delete opt.dataset.usado;        // borra marca vieja
      });

      /* 4. ahora marca s√≥lo los realmente usados ------------ */
      sel.querySelectorAll('option').forEach(opt => {
        if (!opt.value || setDisp.has(opt.value)) return;   // sigue disponible
        opt.disabled = true;               // bloquea selecci√≥n
        opt.dataset.usado = '1';           // para CSS
      });
    }

    async function recargarCombosGrupos () {
      const f = $('#inc_fecha').value || todayISO();

      /* devuelve un Promise con todas las cargas */
      return Promise.all([
        marcarUsados({
          selectId:'inc_grupo',
          urlTodo:'/api/grupos',
          urlDisponibles:`/api/grupos-disponibles?fecha=${f}`,
          placeholder:'Seleccione un grupo'
        }),
        marcarUsados({
          selectId:'inc_ruta',
          urlTodo:'/api/rutas',
          urlDisponibles:`/api/rutas-disponibles?fecha=${f}`,
          placeholder:'Seleccione una ruta'
        })
      ]);
    }

    async function cargarTurnos () {
      const lista = await fetch('/api/turnos').then(r=>r.json());

      /* --- Registro (sigue con value=id) --- */
      const selReg = $('#reg_turno');
      selReg.innerHTML =
        '<option value="">Seleccione turno</option>' +
        lista.map(t => `<option value="${t.id}">${t.descripcion}</option>`).join('');

      /* --- Reporte ‚Üí value = descripci√≥n --- */
      const selRep = $('#rep_turno');
      selRep.innerHTML =
        '<option value="">Todos</option>' +
        lista.map(t => `<option value="${t.descripcion}">${t.descripcion}</option>`).join('');
    }


    async function cargarCategorias() {
      const data = await fetch('/api/inc-tipos').then(r=>r.json());
      CAT_OPTIONS_HTML = '<option value="">Seleccione Categor√≠a</option>' +
        data.map(c => `<option value="${c.id}">${c.descripcion}</option>`).join('');
      // set en todas las .cat actuales
      document.querySelectorAll('#incContainer .cat').forEach(s=>s.innerHTML = CAT_OPTIONS_HTML);

      const selRep = $('#rep_cat');
      selRep.innerHTML = '<option value="">Todas</option>';
      data.forEach(c => selRep.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.descripcion}</option>`));
    }

    /* Utilidad com√∫n ---------------------------------------------------- */
    async function _llenarSelect(sel, url, placeholder = 'Seleccione‚Ä¶') {
      if (!sel) return;
      sel.innerHTML = `<option value="">${placeholder}</option>`;
      try {
        const data = await fetch(url).then(r => r.json());
        data.forEach(it =>
          sel.insertAdjacentHTML('beforeend',
            `<option value="${it.id}">${it.descripcion}</option>`));
      } catch (e) { console.error(e); }
    }

    /* ------------------------------------------------------------------ */
    /* 1.  Grupos del d√≠a  ‚îÄ‚îÄ‚îÄ‚ñ∫  si disponibles = true  ‚Üí solo los que a√∫n
            NO est√©n en inc_grupos para esa fecha (endpoint nuevo)
          si disponibles = false ‚Üí los registrados en inc_grupos (endpoint antiguo)
      ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
    async function cargarGruposHoy(
            fecha = todayISO(),
            selectorId = 'reg_grupo',
            disponibles = false) {

      const sel = document.getElementById(selectorId);
      const endpoint = disponibles
            ? `/api/grupos-disponibles?fecha=${fecha}`   // NO usados todav√≠a
            : `/api/grupos-dia?fecha=${fecha}`;          // ya registrados

      await _llenarSelect(sel, endpoint,
            disponibles ? 'Seleccione un grupo disponible'
                        : 'Seleccione un grupo');
    }

    /* ------------------------------------------------------------------ */
    /* 2.  Rutas disponibles del d√≠a  (nueva funci√≥n, mismo estilo)       */
    async function cargarRutasHoy(
            fecha = todayISO(),
            selectorId = 'inc_ruta') {

      const sel = document.getElementById(selectorId);
      const endpoint = `/api/rutas-disponibles?fecha=${fecha}`;   // NO usadas hoy

      await _llenarSelect(sel, endpoint, 'Seleccione una ruta');
    }


    /* ---------- FECHA & HORA ---------- */
    $('#inc_fecha').value = todayISO();
    $('#inc_llegada').addEventListener('blur',()=>{
      let v = $('#inc_llegada').value.replace(/[^0-9]/g,'');
      if(!v) return;
      $('#inc_llegada').value = v.length===3
        ? `${parseInt(v[0],10)}:${v.slice(1)}`
        : v.length===4 ? `${v.slice(0,2)}:${v.slice(2)}` : $('#inc_llegada').value;
    });

    /* ---------- INCIDENCIAS DIN√ÅMICAS (REGISTRO) ---------- */
    const incContainer   = $('#incContainer');
    const incRowTemplate = incContainer.firstElementChild.cloneNode(true);

    $('#btnAddInc').onclick = () => {
      const c = incRowTemplate.cloneNode(true);
      const catEl = c.querySelector('.cat');
      const comEl = c.querySelector('.coment');
      if (catEl) catEl.innerHTML = CAT_OPTIONS_HTML;
      if (comEl) comEl.value = '';
      incContainer.appendChild(c);
    };

    incContainer.addEventListener('click', e=>{
      if(!e.target.classList.contains('delInc')) return;
      const filas = incContainer.querySelectorAll('.incRow');
      if(filas.length===1){
        filas[0].querySelector('.cat').selectedIndex=0;
        filas[0].querySelector('.coment').value='';
      }else e.target.closest('.incRow').remove();
    });

    /* -------- RESET FORMULARIO GRUPOS (async) -------- */
    async function resetGrupoForm () {
      const f = $('#incidenciaForm');
      f.reset();                                  // limpia inputs ‚Äúvalue‚Äù

      const hoy = todayISO();
      $('#inc_fecha').value = hoy;                // fecha = hoy

      /* 1 ‚ñ∏ recarga cat√°logos ‚Äúest√°ticos‚Äù */
      await Promise.all([
        cargarCatalogo('inc_color','/api/colores'),
        cargarCatalogo('inc_guia', '/api/guias')
      ]);

      /* 2 ‚ñ∏ recarga Ruta y Grupo (y espera) */
      await recargarCombosGrupos();

      /* 3 ‚ñ∏ fuerza todos los selects a la 1.¬™ opci√≥n */
      ['inc_ruta','inc_grupo','inc_color','inc_guia'].forEach(id=>{
        const sel = document.getElementById(id);
        if (sel) sel.selectedIndex = 0;           // ‚ÄúSeleccione‚Ä¶‚Äù
      });

      /* 4 ‚ñ∏ limpia los dos inputs num/hora */
      $('#inc_pax').value     = '';
      $('#inc_llegada').value = '';
    }

    function resetRegistroForm(){
      $('#reg_turno').value = '';
      cargarGruposHoy(todayISO());
      incContainer.innerHTML = '';
      const row = incRowTemplate.cloneNode(true);
      row.querySelector('.cat').innerHTML = CAT_OPTIONS_HTML;
      row.querySelector('.coment').value  = '';
      incContainer.appendChild(row);
    }

    $('#btnRegGrupo').onclick = async () => {
      const formGrupos = $('#incidenciaForm');
      if (!formGrupos.reportValidity()) return;

      const fecha  = $('#inc_fecha').value;
      const ruta   = $('#inc_ruta').value;
      const grupo  = $('#inc_grupo').value;
      const color  = $('#inc_color').value;
      const guia   = $('#inc_guia').value;
      const pax    = $('#inc_pax').value;
      const hora   = $('#inc_llegada').value;

      if (!fecha || !ruta || !grupo || !color || !guia || !hora) {
        alert('Complete todos los campos.');
        return;
      }

      try{
        await fetch('/api/inc-grupos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            fecha,
            ruta_id:  parseInt(ruta),
            grupo_id: parseInt(grupo),
            color_id: parseInt(color),
            guia_id:  parseInt(guia),
            pax:      parseInt(pax||0),
            hora_llegada: hora
          })
        });
        alert('‚úÖ Grupo registrado');
        await resetGrupoForm();                       // ‚Üê¬†ahora s√≠ limpia todo
        recargarCombosGrupos(); // actualiza y deja usados en gris
        cargarGruposHoy($('#inc_fecha').value,'reg_grupo'); // combo en Registro
      }catch(err){console.error(err);alert('Error al registrar grupo');}
    };

    $('#btnSendInc').onclick = async () => {
      const formRegistro = $('#regForm');
      if (!formRegistro.reportValidity()) return;

      const turno_id = $('#reg_turno').value;
      const grupo_id = $('#reg_grupo').value;

      const dets = [...incContainer.querySelectorAll('.incRow')]
        .map(r=>{
          const categoria_id = r.querySelector('.cat')?.value;
          const comentario   = r.querySelector('.coment')?.value.trim();
          return (categoria_id && comentario) ? {categoria_id, comentario} : null;
        }).filter(Boolean);

      if (!turno_id || !grupo_id || !dets.length) {
        alert('Complete turno, grupo y al menos una incidencia');
        return;
      }

      await fetch('/api/incidencias',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ turno_id, grupo_id, incidencias:dets })
      });

      alert('‚úÖ Incidencias enviadas');
      resetRegistroForm();
    };

    /* ---------- LOGIN ---------- */
    $('#loginForm').addEventListener('submit',async e=>{
      e.preventDefault();
      $('#loginError').classList.add('hidden');
      const usuario=$('#user').value.trim(), clave=$('#pass').value.trim();
      if(!usuario||!clave) return $('#loginError').classList.remove('hidden');
      const res=await fetch('/api/login',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({usuario,clave})
      });
      if(!res.ok) return $('#loginError').classList.remove('hidden');
      iniciarApp();
    });

    function iniciarApp(){
      $('#loginForm').classList.add('hidden');
      $('#menu').style.display='flex';
      $('.sections').style.display='block';
      mostrar('incidencias');

      recargarCombosGrupos();
      cargarCatalogo('inc_color','/api/colores');
      cargarCatalogo('inc_guia','/api/guias');
      cargarCatalogo('rep_grupo','/api/grupos','Todos');

      cargarTurnos();
      cargarCategorias();
      cargarGruposHoy(todayISO());
    }

    $('#btnLogout').onclick=()=>{
      $('#loginForm').classList.remove('hidden');
      $('#menu').style.display='none';
      $('.sections').style.display='none';
      $('#loginForm').reset();
    };

    /* ---------- NAV PRINCIPAL ---------- */
    $('#menu').onclick=e=>{
      const sec=e.target.dataset.sec;if(!sec) return;mostrar(sec);
    };
    function mostrar(sec){
      $$('.section').forEach(s=>s.classList.toggle('active',s.id===sec));
      $$('#menu button[data-sec]').forEach(b=>b.classList.toggle('active',b.dataset.sec===sec));
      if(sec==='cfg') loadUsers();
    }

    /* ---------- TABS INCIDENCIAS ---------- */
    $('#incidTabs').onclick=e=>{
      const itab=e.target.dataset.itab;if(!itab) return;
      $('#incidTabs .active')?.classList.remove('active');
      e.target.classList.add('active');
      ['grupos','registro','reporte'].forEach(id=>{
        $('#itab-'+id).classList.toggle('active',id===itab);
      });
      if(itab==='reporte'){ initReporte(); }
      if(itab==='registro'){ cargarGruposHoy($('#inc_fecha').value); }
      if(itab==='grupos'){
        recargarCombosGrupos();                 // muestra todo y des‚Äëhabilita los usados
        cargarCatalogo('inc_color','/api/colores');
        cargarCatalogo('inc_guia','/api/guias');
        refrescarCombos();
      }
    };

    /* =========================================================================================
   ===============          CRUD  GRUPOS        ============================================
   =========================================================================================*/

    let gruposCache=[], editGrupo=null;

    async function loadGrupos(){
      gruposCache = await fetch('/api/grupos').then(r=>r.json());
      const tb = $('#gruposTable tbody'); tb.innerHTML='';
      gruposCache.forEach(g=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${g.descripcion}</td>
            <td>${g.activo ? '‚úî' : '‚úñ'}</td>
            <td>
              <button class="edit"   data-id="${g.id}">‚úè</button>
              <button class="toggle" data-id="${g.id}">${g.activo ? 'üö´' : '‚úî'}
              </button>
            </td>
          </tr>`);
      });
      tb.querySelectorAll('.edit')  .forEach(b=>b.onclick=()=>fillGrupoForm(b.dataset.id));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleGrupo(b.dataset.id));
    }

    function fillGrupoForm(id){
      const g = gruposCache.find(x=>x.id==id);
      $('#g_desc').value = g.descripcion;
      editGrupo = id;
      $('#grupoSubmit').textContent='Guardar';
      $('#grupoCancel').classList.remove('hidden');
    }
    $('#grupoCancel').onclick = e => {e.preventDefault();resetGrupoForm();};
    function resetGrupoForm(){
      $('#g_desc').value=''; editGrupo=null;
      $('#grupoSubmit').textContent='Agregar/Guardar';
      $('#grupoCancel').classList.add('hidden');
    }

    $('#grupoForm').onsubmit = async e=>{
      e.preventDefault();
      const descripcion = $('#g_desc').value.trim();
      if (editGrupo){
        await fetch(`/api/grupos/${editGrupo}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion, activo:1})
        });
      }else{
        await fetch('/api/grupos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion})
        });
      }
      resetGrupoForm(); loadGrupos();
    };

    async function toggleGrupo(id){
      const g = gruposCache.find(x=>x.id==id);
      await fetch(`/api/grupos/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({descripcion:g.descripcion, activo: g.activo?0:1})
      });
      loadGrupos();
    }

    /* =========================================================================================
      ===============          CRUD  RUTAS        =============================================
      =========================================================================================*/
    let rutasCache=[], editRuta=null;
    async function loadRutas(){
      rutasCache = await fetch('/api/rutas').then(r=>r.json());
      const tb = $('#rutasTable tbody'); tb.innerHTML='';
      rutasCache.forEach(r=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${r.descripcion}</td>
            <td>${r.activo?'‚úî':'‚úñ'}</td>
            <td>
              <button class="edit"   data-id="${r.id}">‚úè</button>
              <button class="toggle" data-id="${r.id}">
                ${r.activo?'üö´':'‚úî'}
              </button>
            </td>
          </tr>`);
      });
      tb.querySelectorAll('.edit')  .forEach(b=>b.onclick=()=>fillRutaForm(b.dataset.id));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleRuta(b.dataset.id));
    }
    function fillRutaForm(id){
      const r = rutasCache.find(x=>x.id==id);
      $('#r_desc').value = r.descripcion;
      editRuta = id;
      $('#rutaSubmit').textContent='Guardar';
      $('#rutaCancel').classList.remove('hidden');
    }
    $('#rutaCancel').onclick = e=>{e.preventDefault();resetRutaForm();};
    function resetRutaForm(){
      $('#r_desc').value=''; editRuta=null;
      $('#rutaSubmit').textContent='Agregar/Guardar';
      $('#rutaCancel').classList.add('hidden');
    }
    $('#rutaForm').onsubmit = async e=>{
      e.preventDefault();
      const descripcion = $('#r_desc').value.trim();
      if(editRuta){
        await fetch(`/api/rutas/${editRuta}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion, activo:1})
        });
      }else{
        await fetch('/api/rutas',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion})
        });
      }
      resetRutaForm(); loadRutas(); refrescarCombos();
    };
    async function toggleRuta(id){
      const r = rutasCache.find(x=>x.id==id);
      await fetch(`/api/rutas/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({descripcion:r.descripcion, activo:r.activo?0:1})
      });
      loadRutas(); refrescarCombos();
    }

    /* =========================================================================================
      ===============          CRUD  TURNOS        =============================================
      =========================================================================================*/
    let turnosCache=[], editTurno=null;
    async function loadTurnos(){
      turnosCache = await fetch('/api/turnos').then(r=>r.json());
      const tb = $('#turnosTable tbody'); tb.innerHTML='';
      turnosCache.forEach(t=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${t.descripcion}</td>
            <td>${t.activo?'‚úî':'‚úñ'}</td>
            <td>
              <button class="edit"   data-id="${t.id}">‚úè</button>
              <button class="toggle" data-id="${t.id}">
                ${t.activo?'üö´':'‚úî'}
              </button>
            </td>
          </tr>`);
      });
      tb.querySelectorAll('.edit')  .forEach(b=>b.onclick=()=>fillTurnoForm(b.dataset.id));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleTurno(b.dataset.id));
    }
    function fillTurnoForm(id){
      const t = turnosCache.find(x=>x.id==id);
      $('#t_desc').value=t.descripcion;
      editTurno=id;
      $('#turnoSubmit').textContent='Guardar';
      $('#turnoCancel').classList.remove('hidden');
    }
    $('#turnoCancel').onclick = e=>{e.preventDefault();resetTurnoForm();};
    function resetTurnoForm(){
      $('#t_desc').value=''; editTurno=null;
      $('#turnoSubmit').textContent='Agregar/Guardar';
      $('#turnoCancel').classList.add('hidden');
    }
    $('#turnoForm').onsubmit = async e=>{
      e.preventDefault();
      const descripcion = $('#t_desc').value.trim();
      if(editTurno){
        await fetch(`/api/turnos/${editTurno}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion, activo:1})
        });
      }else{
        await fetch('/api/turnos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion})
        });
      }
      resetTurnoForm(); loadTurnos();
    };
    async function toggleTurno(id){
      const t = turnosCache.find(x=>x.id==id);
      await fetch(`/api/turnos/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({descripcion:t.descripcion, activo:t.activo?0:1})
      });
      loadTurnos();
    }

    /* ====================== CRUD¬†COLORES ==================== */
    let coloresCache=[], editColor=null;

    async function loadColores(){
      coloresCache = await fetch('/api/colores').then(r=>r.json());
      const tb = $('#coloresTable tbody'); tb.innerHTML='';
      coloresCache.forEach(c=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${c.descripcion}</td><td>${c.activo?'‚úî':'‚úñ'}</td>
            <td>
              <button class="edit"   data-id="${c.id}">‚úè</button>
              <button class="toggle" data-id="${c.id}">${c.activo?'üö´':'‚úî'}</button>
            </td>
          </tr>`);});
      tb.querySelectorAll('.edit')  .forEach(b=>b.onclick=()=>fillColorForm(b.dataset.id));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleColor(b.dataset.id));
    }

    function fillColorForm(id){
      const c = coloresCache.find(x=>x.id==id);
      if(!c) return;
      $('#c_nombre').value = c.descripcion;
      editColor = id;
      $('#colorSubmit').textContent='Guardar';
      $('#colorCancel').classList.remove('hidden');
    }

    $('#colorCancel').onclick = e=>{e.preventDefault();resetColorForm();};
    function resetColorForm(){
      $('#c_nombre').value=''; editColor=null;
      $('#colorSubmit').textContent='Agregar/Guardar';
      $('#colorCancel').classList.add('hidden');
    }

    $('#colorForm').onsubmit = async e=>{
      e.preventDefault();
      const nombre = $('#c_nombre').value.trim();
      if(editColor){
        await fetch(`/api/colores/${editColor}`,{
          method:'PUT',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion:nombre,activo:true})
        });
      }else{
        await fetch('/api/colores',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion:nombre})
        });
      }
      resetColorForm(); loadColores();
    };

    async function toggleColor(id){
      const c = coloresCache.find(x=>x.id==id);
      await fetch(`/api/colores/${id}`,{
        method:'PUT',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({descripcion:c.descripcion,activo:!c.activo})
      });
      loadColores();
    }

    /* ====================== CRUD¬†GU√çAS ====================== */
    let guiasCache=[], editGuia=null;

    async function loadGuias(){
      guiasCache = await fetch('/api/guias').then(r=>r.json());
      const tb = $('#guiasTable tbody'); tb.innerHTML='';
      guiasCache.forEach(g=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${g.descripcion}</td><td>${g.activo?'‚úî':'‚úñ'}</td>
            <td>
              <button class="edit"   data-id="${g.id}">‚úè</button>
              <button class="toggle" data-id="${g.id}">${g.activo ? 'üö´' : '‚úî'}</button>
            </td>
          </tr>`);});
      tb.querySelectorAll('.edit')  .forEach(b=>b.onclick=()=>fillGuiaForm(b.dataset.id));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleGuia(b.dataset.id));
    }

    function fillGuiaForm(id){
      const g = guiasCache.find(x=>x.id==id);
      if(!g) return;
      $('#g_nombre').value = g.descripcion;
      editGuia = id;
      $('#guiaSubmit').textContent='Guardar';
      $('#guiaCancel').classList.remove('hidden');
    }

    $('#guiaCancel').onclick = e=>{e.preventDefault();resetGuiaForm();};
    function resetGuiaForm(){
      $('#g_nombre').value=''; editGuia=null;
      $('#guiaSubmit').textContent='Agregar/Guardar';
      $('#guiaCancel').classList.add('hidden');
    }

    $('#guiaForm').onsubmit = async e=>{
      e.preventDefault();
      const nombre = $('#g_nombre').value.trim();
      if(editGuia){
        await fetch(`/api/guias/${editGuia}`,{
          method:'PUT',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion:nombre,activo:true})
        });
      }else{
        await fetch('/api/guias',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({descripcion:nombre})
        });
      }
      resetGuiaForm(); loadGuias();
    };

    async function toggleGuia(id){
      const g = guiasCache.find(x=>x.id==id);
      await fetch(`/api/guias/${id}`,{
        method:'PUT',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({descripcion:g.descripcion,activo:!g.activo})
      });
      loadGuias();
    }
    /* ---------- CRUD USUARIOS ---------- */
    let usuariosCache=[],editUser=null;
    async function loadUsers(){
      usuariosCache=await fetch('/api/usuarios').then(r=>r.json());
      const tb=$('#usersTable tbody');tb.innerHTML='';
      usuariosCache.forEach(u=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${u.usuario}</td><td>${u.rol}</td><td>${u.activo?'‚úî':'‚úñ'}</td>
            <td>
              <button class="edit" data-u="${u.usuario}">‚úè</button>
              <button class="toggle" data-u="${u.usuario}">${u.activo?'üö´':'‚úî'}</button>
            </td>
          </tr>`);});
      tb.querySelectorAll('.edit').forEach(b=>b.onclick=()=>fillUserForm(b.dataset.u));
      tb.querySelectorAll('.toggle').forEach(b=>b.onclick=()=>toggleUser(b.dataset.u));
    }
    function fillUserForm(username){
      const u=usuariosCache.find(x=>x.usuario===username);
      if(!u) return;
      $('#u_user').value=u.usuario;$('#u_user').readOnly=true;
      $('#u_pass').value=u.clave;$('#u_rol').value=u.rol;
      editUser=username;$('#userSubmit').textContent='Guardar';$('#userCancel').classList.remove('hidden');
    }
    $('#userCancel').onclick=e=>{e.preventDefault();resetUserForm();};
    function resetUserForm(){
      $('#u_user').readOnly=false;$('#u_user').value='';$('#u_pass').value='';
      $('#u_rol').value='Usuario';editUser=null;
      $('#userSubmit').textContent='Agregar/Guardar';$('#userCancel').classList.add('hidden');
    }
    $('#userForm').onsubmit=async e=>{
      e.preventDefault();
      const usuario=$('#u_user').value.trim(),clave=$('#u_pass').value.trim(),rol=$('#u_rol').value;
      if(editUser){
        await fetch(`/api/usuarios/${encodeURIComponent(editUser)}`,{
          method:'PUT',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({clave,rol,activo:true})});
      }else{
        await fetch('/api/usuarios',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({usuario,clave,rol})});
      }
      resetUserForm();loadUsers();
    };
    async function toggleUser(username){
      const u=usuariosCache.find(x=>x.usuario===username);
      await fetch(`/api/usuarios/${encodeURIComponent(username)}`,{
        method:'PUT',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({clave:u.clave,rol:u.rol,activo:!u.activo})});
      loadUsers();
    }

    $('#cfgTabs').onclick = e => {
      const tab = e.target.dataset.tab;
      if (!tab) return;

      // cambia visual
      $('#cfgTabs .active')?.classList.remove('active');
      e.target.classList.add('active');
      $$('#cfg .tab-content').forEach(tc =>
        tc.classList.toggle('active', tc.id === 'tab-' + tab));

      // carga seg√∫n pesta√±a
      if (tab === 'users')   loadUsers();
      if (tab === 'guias')   loadGuias();
      if (tab === 'colores') loadColores();

      /* üÜï  nuevas pesta√±as */
      if (tab === 'grupos')  loadGrupos();
      if (tab === 'rutas')   loadRutas();
      if (tab === 'turnos')  loadTurnos();
    };

    /* ---------- REPORTE ---------- */
    function initReporte(){
      if(!$('#rep_desde').value) $('#rep_desde').value = todayISO();
      if(!$('#rep_hasta').value) $('#rep_hasta').value = todayISO();
      cargarTurnos();
      cargarCategorias();
      cargarCatalogo('rep_grupo','/api/grupos','Todos');
      buscarReporte();
    }

    $('#repBuscar').onclick = e=>{
      e.preventDefault();
      buscarReporte();
    };

    async function buscarReporte(){
      const d1 = $('#rep_desde').value || todayISO();
      const d2 = $('#rep_hasta').value || d1;
      const turno = $('#rep_turno').value;
      const grupo = $('#rep_grupo').value;
      const cat   = $('#rep_cat').value;

      const qs = new URLSearchParams({desde:d1,hasta:d2});
      if (turno) qs.append('turno', turno);
      if (grupo) qs.append('grupo_id', grupo);
      if (cat)   qs.append('categoria_id', cat);

      try{
        const res  = await fetch('/api/incidencias-reporte?' + qs.toString());
        if(!res.ok){
          console.error('Error HTTP', res.status, await res.text());
          return;
        }
        const rows = await res.json();
        const tb   = $('#repIncTable tbody');
        tb.innerHTML = '';
        rows.forEach(r=>{
          tb.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${r.fecha||''}</td>
              <td>${r.categoria||''}</td>
              <td>${r.turno||''}</td>
              <td>${r.grupo||''}</td>
              <td>${r.ruta||''}</td>
              <td>${r.guia||''}</td>
              <td>${r.color||''}</td>
              <td style="text-align:left">${r.comentario||''}</td>
            </tr>`);
        });
      }catch(err){
        console.error(err);
      }
    }

    /* ------------------------------------------------------------
   EXPORTAR REPORTE A EXCEL
   ------------------------------------------------------------ */
    document.getElementById('repExport').onclick = () => {
      const tbl = document.getElementById('repIncTable');
      if (!tbl.tBodies[0].rows.length){
        alert('No hay datos para exportar'); return;
      }

      /* 1 ‚ñ∏ hoja a partir de la tabla */
      const ws = XLSX.utils.table_to_sheet(tbl);

      /* 2 ‚ñ∏ colores */
      const C_HEADER = '7C3AED';   // morado
      const C_ROW    = 'E0D7FB';   // lila muy claro
      const C_WHITE  = 'FFFFFF';

      const rango = XLSX.utils.decode_range(ws['!ref']);
      const filaHeader = rango.s.r;
      const filaFin    = rango.e.r;

      /* 3 ‚ñ∏ formateo */
      for(let R=filaHeader; R<=filaFin; ++R){
        for(let C=rango.s.c; C<=rango.e.c; ++C){
          const addr = XLSX.utils.encode_cell({r:R,c:C});
          const cell = ws[addr]; if(!cell) continue;

          cell.s = cell.s || {};
          cell.s.border = {top:{style:'thin',color:{auto:1}},
                          bottom:{style:'thin',color:{auto:1}},
                          left:{style:'thin',color:{auto:1}},
                          right:{style:'thin',color:{auto:1}}};
          cell.s.alignment = {horizontal:'center',vertical:'center',wrapText:false};

          if(R===filaHeader){
            cell.s.fill = {fgColor:{rgb:C_HEADER}};
            cell.s.font = {bold:true,color:{rgb:C_WHITE}};
          }else if(R%2){
            cell.s.fill = {fgColor:{rgb:C_ROW}};
          }
        }
      }

      /* 4 ‚ñ∏ auto‚Äëancho simple */
      ws['!cols'] = [];
      for(let C=rango.s.c; C<=rango.e.c; ++C){
        let maxLen=8;
        for(let R=rango.s.r; R<=rango.e.r; ++R){
          const v = ws[XLSX.utils.encode_cell({r:R,c:C})]?.v;
          maxLen = Math.max(maxLen, String(v||'').length);
        }
        ws['!cols'].push({wch:maxLen+2});
      }

      /* 5 ‚ñ∏ libro y descarga */
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
      const hoy = todayISO();
      XLSX.writeFile(wb, `reporte_incidencias_${hoy}.xlsx`);
    };

  </script>
</body>
</html>











